<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot ‚Äì Kognitivni Trening</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body class="chat-page">
    <div class="chat-shell">

        <!-- LEVI STOLPEC - TRIGGERJI -->
        <aside class="sidebar-left" id="trigger-panel">

            <div class="trigger-section">
                <div class="trigger-heading">
                    <span class="heading-dot positive-dot"></span>
                    <h4>‚ú® Pozitivni signali</h4>
                </div>
                <div class="trigger-grid">
                    {% if triggers.positive %}
                        {% for trigger in triggers.positive %}
                        <button class="trigger-pill positive" onclick="sendTrigger('{{ trigger }}')">
                            {{ trigger }}
                        </button>
                        {% endfor %}
                    {% else %}
                        <button class="trigger-pill positive" onclick="sendTrigger('User smiles / laughs')">User smiles / laughs</button>
                        <button class="trigger-pill positive" onclick="sendTrigger('Positive affect')">Positive affect</button>
                    {% endif %}
                </div>
            </div>

            <div class="trigger-section">
                <div class="trigger-heading">
                    <span class="heading-dot neutral-dot"></span>
                    <h4>‚è∏Ô∏è Nevtralni signali</h4>
                </div>
                <div class="trigger-grid">
                    {% if triggers.neutral %}
                        {% for trigger in triggers.neutral %}
                        <button class="trigger-pill neutral" onclick="sendTrigger('{{ trigger }}')">
                            {{ trigger }}
                        </button>
                        {% endfor %}
                    {% else %}
                        <button class="trigger-pill neutral" onclick="sendTrigger('Long silence')">Long silence</button>
                        <button class="trigger-pill neutral" onclick="sendTrigger('User confused / waiting')">User confused / waiting</button>
                    {% endif %}
                </div>
            </div>

            <div class="trigger-section">
                <div class="trigger-heading">
                    <span class="heading-dot negative-dot"></span>
                    <h4>‚ö†Ô∏è Negativni signali</h4>
                </div>
                <div class="trigger-grid">
                    {% if triggers.negative %}
                        {% for trigger in triggers.negative %}
                        <button class="trigger-pill negative" onclick="sendTrigger('{{ trigger }}')">
                            {{ trigger }}
                        </button>
                        {% endfor %}
                    {% else %}
                        <button class="trigger-pill negative" onclick="sendTrigger('User frustrated / overloaded')">User frustrated / overloaded</button>
                        <button class="trigger-pill negative" onclick="sendTrigger('User decreasing engagement')">User decreasing engagement</button>
                    {% endif %}
                </div>
            </div>

            <div class="trigger-section">
                <div class="trigger-heading">
                    <span class="heading-dot final-dot"></span>
                    <h4>üèÅ Zakljuƒçni signali</h4>
                </div>
                <div class="trigger-grid">
                    {% if triggers.final %}
                        {% for trigger in triggers.final %}
                        <button class="trigger-pill final" onclick="sendTrigger('{{ trigger }}')">
                            {{ trigger }}
                        </button>
                        {% endfor %}
                    {% else %}
                        <button class="trigger-pill final" onclick="sendTrigger('end of user speech')">end of user speech</button>
                        <button class="trigger-pill final" onclick="sendTrigger('end of user movement')">end of user movement</button>
                    {% endif %}
                </div>
            </div>
        </aside>

        <!-- GLAVNI DEL - CHAT -->
        <main class="main-content">
            <header class="chat-header">
                <div class="header-top">
                    <div class="header-icon">
                        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9.75 17L9 20l-1 1h8l-1-1 .75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div>
                        <div class="header-title">Robot ‚Äì Kognitivni Trening</div>
                        <div class="header-subtitle">Interaktivni pogovor in sledenje stanj</div>
                    </div>
                </div>


                <div class="progress-container">

                    <div class="progress-states">
                        <div class="fsm-state {{ 'active' if current_state == 'S0_GREETING' else '' }}" data-state="S0_GREETING">Pozdrav</div>
                        <div class="fsm-state {{ 'active' if current_state == 'S1_EXPLANATION' else '' }}" data-state="S1_EXPLANATION">Razlaga</div>
                        <div class="fsm-state {{ 'active' if current_state == 'S2_EXERCISE' else '' }}" data-state="S2_EXERCISE">Vaja</div>
                        <div class="fsm-state {{ 'active' if current_state == 'S3_BREAK' else '' }}" data-state="S3_BREAK">Odmor</div>
                        <div class="fsm-state {{ 'active' if current_state == 'S4_FEEDBACK' else '' }}" data-state="S4_FEEDBACK">Zakljuƒçek</div>
                    </div>
                </div>
            </header>

            <div class="chat-area" id="chat-box">
                {% for message in conversation %}
                <div class="message {{ 'robot-message' if message.sender == 'robot' else 'user-message' }} {% if message.get('type') %}{{ message.type }}-type{% endif %}">
                    <div class="message-bubble">
                        {{ message.text }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <footer class="stats-footer">
                <div class="stat-box">
                    <span class="stat-number" id="stat-positive">{{ statistics.positive_interactions }}</span>
                    <span class="stat-label">Pozitivnih</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="stat-negative">{{ statistics.negative_interactions }}</span>
                    <span class="stat-label">Negativnih</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="stat-escalation">{{ statistics.total_escalations }}</span>
                    <span class="stat-label">Eskalacij</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="stat-steps">{{ statistics.step_count }}</span>
                    <span class="stat-label">Korakov</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="stat-success">{{ statistics.success_steps }}/5</span>
                    <span class="stat-label">Uspe≈°nih</span>
                </div>
            </footer>
        </main>

        <!-- DESNI STOLPEC - KONTROLA -->
        <aside class="sidebar-right">
            <h3 class="sidebar-title">Kontrola seje</h3>

            <button class="control-btn btn-end" id="force-end-btn" onclick="forceEnd()">
                <svg viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Zakljuƒçi sejo
            </button>

            <button class="control-btn btn-normal" id="reset-session" onclick="resetSession()">
                <svg viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Nova seja
            </button>

            <a class="control-btn btn-normal link-btn" href="/evaluate">
                <svg viewBox="0 0 24 24"><path d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Statistika
            </a>
        </aside>
    </div>

    <!-- Notification za END stanje z evalvacijo -->
    <div id="end-notification" class="hidden">
        <div class="notification-content evaluation-modal">
            <h3>üéâ Seja zakljuƒçena</h3>
            <p id="end-reason-text">Trening je bil uspe≈°no zakljuƒçen.</p>

            <div id="final-stats">
                <div class="final-stat">
                    <span class="final-stat-label">Koraki:</span>
                    <span class="final-stat-value" id="final-steps">0</span>
                </div>
                <div class="final-stat">
                    <span class="final-stat-label">Pozitivnih:</span>
                    <span class="final-stat-value" id="final-positive">0</span>
                </div>
                <div class="final-stat">
                    <span class="final-stat-label">Eskalacij:</span>
                    <span class="final-stat-value" id="final-escalation">0</span>
                </div>
            </div>

            <!-- Evalvacija uporabnika -->
            <div id="evaluation-section">
                <h4>‚≠ê Oceni interakcijo z robotom</h4>

                <div class="eval-question">
                    <label>Robot se mi zdi <strong>podporen</strong></label>
                    <div class="star-rating" data-question="supportive">
                        <span class="star" data-value="1">‚òÜ</span>
                        <span class="star" data-value="2">‚òÜ</span>
                        <span class="star" data-value="3">‚òÜ</span>
                        <span class="star" data-value="4">‚òÜ</span>
                        <span class="star" data-value="5">‚òÜ</span>
                    </div>
                </div>

                <div class="eval-question">
                    <label>Robot se mi zdi <strong>razumljiv</strong></label>
                    <div class="star-rating" data-question="understandable">
                        <span class="star" data-value="1">‚òÜ</span>
                        <span class="star" data-value="2">‚òÜ</span>
                        <span class="star" data-value="3">‚òÜ</span>
                        <span class="star" data-value="4">‚òÜ</span>
                        <span class="star" data-value="5">‚òÜ</span>
                    </div>
                </div>

                <div class="eval-question">
                    <label>Robot se mi zdi <strong>nevsiljiv</strong></label>
                    <div class="star-rating" data-question="non_intrusive">
                        <span class="star" data-value="1">‚òÜ</span>
                        <span class="star" data-value="2">‚òÜ</span>
                        <span class="star" data-value="3">‚òÜ</span>
                        <span class="star" data-value="4">‚òÜ</span>
                        <span class="star" data-value="5">‚òÜ</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button onclick="submitEvaluation()" id="submit-eval-btn" class="btn-primary">
                    Oddaj oceno in zaƒçni novo sejo
                </button>
                <button onclick="skipEvaluation()" class="btn-secondary">
                    Preskoƒçi
                </button>
            </div>
        </div>
    </div>

    <!-- Notification za predlog zakljuƒçka -->
    <div id="suggest-end-notification" class="hidden">
        <div class="notification-content warning">
            <h3>‚ö†Ô∏è Preveƒç te≈æav</h3>
            <p>Robot je zaznal veƒç te≈æav. ≈Ωeli≈° zakljuƒçiti ali nadaljevati?</p>
            <div class="notification-buttons">
                <button onclick="forceEnd()" class="btn-end">Zakljuƒçi</button>
                <button onclick="hideSuggestEnd()" class="btn-continue">Nadaljuj</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
